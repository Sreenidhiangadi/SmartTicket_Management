<div class="container-fluid px-4" *ngIf="!loading && ticket">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold">{{ ticket.title }}</h4>
    <span class="badge bg-secondary">{{ ticket.status }}</span>
  </div>

  <p class="text-muted">{{ ticket.description }}</p>

  <div class="mb-3">
    <span class="badge bg-info me-2">{{ ticket.priority }}</span>
    <small class="text-muted">
      Created: {{ ticket.createdAt | date:'short' }}
    </small>
  </div>
<div *ngIf="ticket.assignedTo" class="text-muted small mb-3">
  Assigned to:
  <strong>{{ getAssignedAgentName() }}</strong>
</div>

  <!-- MANAGER ACTIONS -->
  <div class="mb-4" *ngIf="isManager()">

    <!-- Assign / Reassign -->
    <div class="d-flex align-items-center gap-2 mb-2">
      <select
        class="form-select w-auto"
        [(ngModel)]="selectedAgentId"
      >
        <option value="" disabled>Select agent</option>
        <option *ngFor="let a of agents" [value]="a.id">
          {{ a.name }}
        </option>
      </select>

 <button
  class="btn btn-outline-primary"
  (click)="assign()"
  [disabled]="
    !selectedAgentId ||
    ticket.status === 'CLOSED' ||
    selectedAgentId === ticket.assignedTo
  "
>
  {{ ticket.assignedTo ? 'Reassign' : 'Assign' }}
</button>

    </div>

    <!-- Reopen -->
    <button
      *ngIf="ticket.status === 'RESOLVED' || ticket.status === 'CLOSED'"
      class="btn btn-outline-warning"
      (click)="reopen()"
    >
      Reopen Ticket
    </button>

  </div>

  <!-- AGENT ACTIONS -->
  <div class="mb-4" *ngIf="hasRole('AGENT')">

    <button
      *ngIf="ticket.status === 'ASSIGNED'"
      class="btn btn-outline-primary me-2"
      (click)="start()">
      Start
    </button>

    <button
      *ngIf="ticket.status === 'IN_PROGRESS'"
      class="btn btn-outline-success me-2"
      (click)="resolve()">
      Resolve
    </button>

    <button
      *ngIf="ticket.status === 'RESOLVED'"
      class="btn btn-outline-danger"
      (click)="close()">
      Close
    </button>

  </div>

  <!-- TIMELINE -->
  <h5>Timeline</h5>
  <ul class="list-group mb-4">
    <li class="list-group-item" *ngFor="let e of timeline">
      <strong>{{ e.action }}</strong>
      <small class="text-muted float-end">
        {{ e.timestamp | date:'short' }}
      </small>
    </li>
  </ul>

  <!-- COMMENTS -->
  <h5>Comments</h5>

  <div class="mb-3" *ngFor="let c of comments">
    <div class="border rounded p-3">

      <div class="d-flex justify-content-between">
        <small class="fw-bold">
          {{ c.commentedBy }}
          <span class="badge bg-secondary ms-1">
            {{ c.role }}
          </span>
        </small>

        <small class="text-muted">
          {{ c.commentedAt | date:'short' }}
        </small>
      </div>

      <p class="mb-0 mt-2">
        {{ c.comment }}
      </p>

    </div>
  </div>

  <!-- ADD COMMENT -->
  <div
    class="card mb-4"
    *ngIf="ticket.status !== 'CLOSED'"
  >
    <div class="card-body">

      <label class="form-label fw-semibold">
        Add a comment
      </label>

      <textarea
        class="form-control mb-2"
        rows="3"
        [(ngModel)]="newComment"
        placeholder="Write your comment..."
      ></textarea>

      <button
        class="btn btn-primary btn-sm"
        [disabled]="submittingComment || !newComment.trim()"
        (click)="addComment()"
      >
        <span *ngIf="!submittingComment">Post Comment</span>
        <span *ngIf="submittingComment">Posting...</span>
      </button>

    </div>
  </div>

</div>
